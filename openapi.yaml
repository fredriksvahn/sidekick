openapi: 3.0.3
info:
  title: Sidekick API
  version: 1.0.0
servers:
  - url: http://localhost:1337
paths:
  /auth/login:
    post:
      summary: Login and create a session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Session created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '400':
          description: Missing or invalid fields
          content:
            text/plain:
              schema:
                type: string
        '401':
          description: Invalid credentials
          content:
            text/plain:
              schema:
                type: string
        '429':
          description: Too many failed login attempts
          content:
            text/plain:
              schema:
                type: string
  /auth/logout:
    post:
      summary: Logout and clear session
      responses:
        '204':
          description: Logged out
  /auth/me:
    get:
      summary: Get current authenticated user
      responses:
        '200':
          description: Current user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '401':
          description: Not authenticated
          content:
            text/plain:
              schema:
                type: string
  /health:
    get:
      summary: Health check
      responses:
        '200':
          description: OK
  /execute:
    post:
      summary: Execute a stateless prompt
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                messages:
                  type: array
                  items:
                    $ref: '#/components/schemas/ChatMessage'
                agent:
                  type: string
                  description: Agent ID to use for this request
                verbosity:
                  type: integer
                  minimum: 0
                  maximum: 4
                stream:
                  type: boolean
                  description: Enable SSE streaming with real-time tokens and progress events
              required:
                - messages
      responses:
        '200':
          description: Reply (non-streaming or streaming)
          content:
            application/json:
              schema:
                type: object
                properties:
                  reply:
                    type: string
                  warning:
                    type: string
                required:
                  - reply
            text/event-stream:
              schema:
                type: string
              description: Server-sent events with progress, deltas, and completion
              example: |
                event: progress
                data: {"stage":"planning"}

                event: progress
                data: {"stage":"generating","effective_verbosity":2,"token_budget":2048,"escalated":false}

                data: {"delta":"Hello"}

                data: {"delta":" world"}

                event: progress
                data: {"stage":"finalizing"}

                data: {"done":true}

        '502':
          description: Upstream execution error
          content:
            text/plain:
              schema:
                type: string
  /chat:
    post:
      summary: Canonical persisted chat
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
      responses:
        '200':
          description: Reply (non-streaming or streaming)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
            text/event-stream:
              schema:
                type: string
              description: Server-sent events with progress, deltas, and completion
              example: |
                event: progress
                data: {"stage":"planning"}

                event: progress
                data: {"stage":"generating","effective_verbosity":2,"token_budget":2048,"escalated":false}

                data: {"delta":"Hello"}

                data: {"delta":" world"}

                event: progress
                data: {"stage":"finalizing"}

                data: {"done":true,"context":{"name":"my-context","agent":"default","verbosity":2}}

        '400':
          description: Invalid request
          content:
            text/plain:
              schema:
                type: string
        '500':
          description: Model or execution error
          content:
            text/plain:
              schema:
                type: string
  /contexts:
    get:
      summary: List contexts
      responses:
        '200':
          description: Contexts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ContextListItem'
  /contexts/{name}:
    patch:
      summary: Update or rename a context
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ContextUpdate'
      responses:
        '200':
          description: Updated context
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContextMeta'
        '404':
          description: Context not found
        '409':
          description: Context already exists
    delete:
      summary: Soft delete a context
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Deleted
        '404':
          description: Context not found
  /contexts/{name}/messages:
    get:
      summary: Get context messages
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Messages
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/StoredMessage'
        '404':
          description: Context not found
  /agents:
    get:
      summary: List agents
      parameters:
        - name: enabled
          in: query
          required: false
          schema:
            type: string
            enum: ["true", "false"]
      responses:
        '200':
          description: Agents
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Agent'
    post:
      summary: Create an agent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AgentInput'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Agent'
        '409':
          description: Agent already exists
  /agents/{id}:
    get:
      summary: Get an agent
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Agent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Agent'
        '404':
          description: Agent not found
    patch:
      summary: Update an agent
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AgentUpdate'
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Agent'
        '403':
          description: Attempt to modify global agent properties (only enabled is mutable)
        '404':
          description: Agent not found
    delete:
      summary: Delete an agent
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Deleted
        '404':
          description: Agent not found
  /settings:
    get:
      summary: Get defaults
      responses:
        '200':
          description: Settings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Settings'
  /verbosity/keywords:
    get:
      summary: List verbosity escalation keywords
      responses:
        '200':
          description: Verbosity keywords
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/VerbosityKeyword'
    post:
      summary: Create a verbosity escalation keyword
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VerbosityKeywordInput'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerbosityKeyword'
        '400':
          description: Invalid input
        '500':
          description: Database error
  /verbosity/keywords/{keyword}:
    patch:
      summary: Update a verbosity escalation keyword
      parameters:
        - name: keyword
          in: path
          required: true
          schema:
            type: string
          description: The keyword to update (immutable primary key)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VerbosityKeywordUpdate'
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerbosityKeyword'
        '400':
          description: Invalid input
        '404':
          description: Keyword not found
        '500':
          description: Database error
    delete:
      summary: Delete a verbosity escalation keyword
      parameters:
        - name: keyword
          in: path
          required: true
          schema:
            type: string
          description: The keyword to delete
      responses:
        '204':
          description: Deleted
        '404':
          description: Keyword not found
        '500':
          description: Database error
components:
  schemas:
    LoginRequest:
      type: object
      properties:
        email:
          type: string
          format: email
        password:
          type: string
      required:
        - email
        - password
    LoginResponse:
      type: object
      properties:
        user_id:
          type: string
        email:
          type: string
        expires_at:
          type: string
          format: date-time
      required:
        - user_id
        - email
        - expires_at
    UserProfile:
      type: object
      properties:
        user_id:
          type: string
        email:
          type: string
        created_at:
          type: string
          format: date-time
        last_login_at:
          type: string
          format: date-time
          nullable: true
      required:
        - user_id
        - email
        - created_at
    ChatMessage:
      type: object
      properties:
        role:
          type: string
        content:
          type: string
        agent:
          type: string
        verbosity:
          type: integer
          minimum: 0
          maximum: 4
      required:
        - role
        - content
    StoredMessage:
      type: object
      properties:
        role:
          type: string
        content:
          type: string
        agent:
          type: string
        verbosity:
          type: integer
          minimum: 0
          maximum: 4
        time:
          type: string
          format: date-time
      required:
        - role
        - content
        - time
    ChatRequest:
      type: object
      properties:
        context:
          type: string
        agent:
          type: string
        verbosity:
          type: integer
          minimum: 0
          maximum: 4
        messages:
          type: array
          items:
            $ref: '#/components/schemas/ChatMessage'
        stream:
          type: boolean
      required:
        - context
        - messages
    ChatResponse:
      type: object
      properties:
        reply:
          type: string
        context:
          $ref: '#/components/schemas/ContextMeta'
        warning:
          type: string
      required:
        - reply
        - context
    ContextListItem:
      type: object
      properties:
        name:
          type: string
        message_count:
          type: integer
        agent:
          type: string
        verbosity:
          type: integer
      required:
        - name
        - message_count
        - agent
        - verbosity
    ContextMeta:
      type: object
      properties:
        name:
          type: string
        agent:
          type: string
        verbosity:
          type: integer
      required:
        - name
        - agent
        - verbosity
    ContextUpdate:
      type: object
      properties:
        name:
          type: string
        agent:
          type: string
        verbosity:
          type: integer
          minimum: 0
          maximum: 4
    Agent:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        base_agent:
          type: string
          nullable: true
        model:
          type: string
        system_prompt:
          type: string
        default_verbosity:
          type: integer
          minimum: 0
          maximum: 4
        enabled:
          type: boolean
        revision:
          type: integer
        updated_at:
          type: string
          format: date-time
      required:
        - id
        - name
        - model
        - system_prompt
        - default_verbosity
        - enabled
        - revision
        - updated_at
    AgentInput:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        base_agent:
          type: string
          nullable: true
        model:
          type: string
        system_prompt:
          type: string
        default_verbosity:
          type: integer
          minimum: 0
          maximum: 4
        enabled:
          type: boolean
      required:
        - id
        - name
        - model
        - system_prompt
    AgentUpdate:
      type: object
      description: Only the user-level enabled toggle can be updated. Global agent properties are immutable via this API.
      properties:
        enabled:
          type: boolean
      required:
        - enabled
    Settings:
      type: object
      properties:
        default_agent:
          type: string
        default_verbosity:
          type: integer
          minimum: 0
          maximum: 4
      required:
        - default_agent
        - default_verbosity
    VerbosityKeyword:
      type: object
      properties:
        keyword:
          type: string
          description: The keyword to match in user messages (primary key)
        agent:
          type: string
          nullable: true
          description: Agent name for agent-specific escalation (null means global)
        min_requested:
          type: integer
          minimum: 0
          maximum: 4
          description: Minimum requested verbosity level for escalation to trigger
        escalate_to:
          type: integer
          minimum: 0
          maximum: 4
          description: Verbosity level to escalate to when keyword matches
        enabled:
          type: boolean
          description: Whether this keyword escalation rule is active
        created_at:
          type: string
          format: date-time
          description: When this keyword was created
      required:
        - keyword
        - min_requested
        - escalate_to
        - enabled
        - created_at
    VerbosityKeywordInput:
      type: object
      properties:
        keyword:
          type: string
          description: The keyword to match in user messages
        agent:
          type: string
          nullable: true
          description: Agent name for agent-specific escalation (null means global)
        min_requested:
          type: integer
          minimum: 0
          maximum: 4
          description: Minimum requested verbosity level for escalation to trigger
        escalate_to:
          type: integer
          minimum: 0
          maximum: 4
          description: Verbosity level to escalate to when keyword matches
        enabled:
          type: boolean
          description: Whether this keyword escalation rule is active (default true)
      required:
        - keyword
        - min_requested
        - escalate_to
    VerbosityKeywordUpdate:
      type: object
      properties:
        min_requested:
          type: integer
          minimum: 0
          maximum: 4
          description: Minimum requested verbosity level for escalation to trigger
        escalate_to:
          type: integer
          minimum: 0
          maximum: 4
          description: Verbosity level to escalate to when keyword matches
        enabled:
          type: boolean
          description: Whether this keyword escalation rule is active
      description: Update fields for a verbosity keyword. Keyword itself is immutable.
